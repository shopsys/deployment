apiVersion: v1
kind: Namespace
metadata:
  name: myproject-production
---
apiVersion: v1
data:
  .project_env.sh: |
    export ELASTICSEARCH_HOST='http://elasticsearch:9200'
    export TRUSTED_PROXY='10.0.0.0/8'
    export DATABASE_NAME='myproject-production'
    export S3_ENDPOINT='https://s3.example.com'
    export MAILER_FORCE_WHITELIST='false'
    export DATABASE_USER='myproject-production'
    export DATABASE_PORT='5432'
    export MESSENGER_TRANSPORT_DSN='amqp://guest:guest@rabbitmq:5672/%2f/messages'
    export REDIS_PREFIX='myproject-production'
    export DATABASE_PASSWORD='test-db-password'
    export DATABASE_HOST='10.0.0.100'
    export ELASTIC_SEARCH_INDEX_PREFIX='myproject-production'
    export SENTRY_RELEASE='479411e7'
    export S3_SECRET='test-s3-secret'
    export MAILER_DSN='smtp://mailhog:1025'
    export S3_BUCKET_NAME='myproject-production'
    export S3_ACCESS_KEY='myproject-production'
    export APP_SECRET='test-app-secret-key'
kind: ConfigMap
metadata:
  name: cron-env
  namespace: myproject-production
---
apiVersion: v1
data:
  cron: |+
    PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    */5 * * * * . /root/.project_env.sh && cd /var/www/html/ && ./phing cron > /dev/null 2>&1

kind: ConfigMap
metadata:
  name: cron-list
  namespace: myproject-production
---
apiVersion: v1
data:
  domains_urls.yaml: |
    domains_urls:
      - id: 1
        url: https://www.example.com
      - id: 2
        url: https://www.example.sk
kind: ConfigMap
metadata:
  name: domains-urls-m8t7497btf
  namespace: myproject-production
---
apiVersion: v1
data:
  nginx.conf: |
    user  nginx;
    worker_processes 2;

    error_log   /dev/stderr warn;
    pid         /var/run/nginx.pid;

    events {
        # determines how much clients will be served per worker
        # max clients = worker_connections * worker_processes
        # max clients is also limited by the number of socket connections available on the system (~64k)
        worker_connections 512;
    }

    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
            '$status $body_bytes_sent "$http_referer" '
            '"$http_user_agent" "$http_x_forwarded_for" '
            '"host=$host" '
            'upstream_response_time=$upstream_response_time';

        access_log /dev/stdout main;

        sendfile        on;
        tcp_nopush      on;
        tcp_nodelay     on;

        keepalive_timeout  65;

        server_names_hash_bucket_size 64;

        include /etc/nginx/conf.d/*.conf;
    }
  project-nginx.conf: |
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_vary on;
    gzip_types  text/plain
                text/css
                text/javascript
                application/javascript
                application/json
                application/xml
                application/rss+xml
                image/svg+xml;

    upstream php-upstream {
        server php-fpm:9000;
    }

    upstream storefront-upstream {
        server storefront:3000;
    }

    # storefront error page if accessed directly, plain text 404 if accessed via CDN
    map "$http_cdn_vshosting_real_ip$http_cdn_vshosting_real_ip_img" $custom_error_target {
        default @storefront;
        "~.+"  @404;
    }

    server {
        listen 80;
        root /var/www/html/web;

        location /health {
            access_log   off;

            include fastcgi_params;
            fastcgi_read_timeout 3s;
            fastcgi_param SCRIPT_FILENAME /ping;
            fastcgi_param SCRIPT_NAME     /ping;
            fastcgi_param REQUEST_METHOD  GET;

            fastcgi_pass php-upstream;
        }
    }

    server {
        listen 8080;
        root /var/www/html/web;
        server_tokens off;
        proxy_ignore_client_abort on;

        proxy_buffer_size 16k;
        proxy_buffers 32 16k;

        client_body_buffer_size 32k;
        client_header_buffer_size 1k;
        client_max_body_size    32m;
        large_client_header_buffers 4 8k;

        fastcgi_buffer_size 16k;
        fastcgi_buffers 32 16k;

        types_hash_max_size 2048;

        set_real_ip_from  10.0.0.0/8;
        set_real_ip_from 103.21.244.0/22;
        set_real_ip_from 103.22.200.0/22;
        set_real_ip_from 103.31.4.0/22;
        set_real_ip_from 104.16.0.0/13;
        set_real_ip_from 104.24.0.0/14;
        set_real_ip_from 108.162.192.0/18;
        set_real_ip_from 131.0.72.0/22;
        set_real_ip_from 141.101.64.0/18;
        set_real_ip_from 162.158.0.0/15;
        set_real_ip_from 172.64.0.0/13;
        set_real_ip_from 173.245.48.0/20;
        set_real_ip_from 188.114.96.0/20;
        set_real_ip_from 190.93.240.0/20;
        set_real_ip_from 197.234.240.0/22;
        set_real_ip_from 198.41.128.0/17;
        set_real_ip_from 2400:cb00::/32;
        set_real_ip_from 2606:4700::/32;
        set_real_ip_from 2803:f800::/32;
        set_real_ip_from 2405:b500::/32;
        set_real_ip_from 2405:8100::/32;
        set_real_ip_from 2a06:98c0::/29;
        set_real_ip_from 2c0f:f248::/32;

        real_ip_header    X-Forwarded-For;
        real_ip_recursive on;

        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Credentials "false" always;
        add_header VSHCDN-WEBP-QUALITY 90;
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";

        set $request_host $http_host;
        if ($http_originalhost) {
            set $request_host $http_originalhost;
        }

        # define code to be used to redirect to the proper upstream
        error_page 470 = @app;
        error_page 469 = @storefront;
        error_page 468 = @imageResizer;

        location = /resolve-friendly-url {
            allow 10.0.0.0/8;
            allow 127.0.0.0/8;
            allow 172.16.0.0/12;
            allow 192.168.0.0/16;
            deny all;

            fastcgi_pass php-upstream;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $realpath_root/resolveFriendlyUrl.php;
        }

        # (?:/|$) in regexes is used to match /path, /path/, /path/subpath but not /pathology

        # location always using the app backend, no static files
        location ~ ^/(?:[^/]+/)?(graphql|_profiler|_wdt|_error)(?:/|$) {
            return 470; # send to @app
        }

        # location for administration interface, uses admin error pages
        location ~ ^/(?:[^/]+/)?(admin|ckeditor|elfinder(\.main\.js)?|efconnect|build|bundles)(?:/|$) {
            # hide dotfiles (send to @app)
            location ~ /\. {
                return 470; # send to @app
            }

            try_files $uri @app;
        }

        # location for static files, uses storefront error pages
        location ~ ^/(public)/ {
            # hide dotfiles (send to @app)
            location ~ /\. {
                return 469; # send to @storefront
            }

            try_files $uri $custom_error_target;
        }

        location ~ ^/content/images/(?<entity_name>\w+)(?<image_type>/\w+)?/(?<image_size>(default|original|galleryThumbnail|modal|list|thumbnail|thumbnailSmall|thumbnailExtraSmall|thumbnailMedium|header|footer|productList|productListSecondRow|cartPreview|productListMiddle|productListMiddleRetina|listAside|listGrid|searchThumbnail|listBig)/)(?<add_image_id>\d+--)?(?<image_name>([\w\-]+_)?(?<image_id>\d+))\.(?<image_extension>jpg|jpeg|png|gif) {
             expires 1w;
             return 301 $scheme://$http_host/content/images/$entity_name$image_type/$image_name.$image_extension$is_args$args;
        }

        # location for images, strip image name and serve image by its ID (send to imageResizer if there are width/height args)
        location ~ ^/(?:[^/]+/)?(content(?:-test)?/images/.+)/(?<image_name>([\w\-]+_)?(?<image_id>\d+))\.(?<image_extension>jpe?g|png|gif) {
            expires 1y;

            error_page              403 404 = $custom_error_target;
            # this needs to be repeated here because of nginx error_page inheritance rules
            error_page              468 = @imageResizer;

            if ($is_args != '') {
                return 468; # send to @imageResizer
            }

            proxy_intercept_errors  on;

            proxy_http_version      1.1;
            proxy_set_header        Authorization "";
            proxy_buffering         off;

            proxy_pass https://s3.example.com/myproject-production/web/$1/$image_id.$image_extension;
        }

        location ~ ^/(content)/ {
            proxy_intercept_errors  on;
            error_page              404 = $custom_error_target;

            proxy_http_version      1.1;
            proxy_set_header        Authorization "";
            proxy_buffering         off;

            proxy_pass              https://s3.example.com/myproject-production/web$request_uri;
        }

        # location for backend routes used by customers
        # they have to force storefront 404 page if not found
        # throw NotFoundRedirectToStorefrontException to trigger this behavior
        location ~ ^/(?:[^/]+/)?(file|customer-file/(view|download)|personal-overview-export/xml|social-network/login|convertim)(?:/|$) {
            location ~ /\. {
                # hide dotfiles (send to @storefront)
                return 469;
            }

            try_files $uri @app;
        }

        location ^~ /_next/ {
            return 469; # send to @storefront
        }

        # disallow access to dynamic content from CDN
        location ~ / {
            if ($http_cdn_vshosting_real_ip != '') {
                return 403;
            }
            if ($http_cdn_vshosting_real_ip_img != '') {
                return 403;
            }

            return 469; # send to @storefront
        }

        location @storefront {
            internal;
            proxy_hide_header Access-Control-Allow-Origin;
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_pass http://storefront-upstream;
        }

        location @app {
            fastcgi_pass php-upstream;
            include fastcgi_params;
            fastcgi_param HTTP_HOST $request_host;
            # use $realpath_root instead of $document_root
            # because of symlink switching when deploying
            fastcgi_send_timeout 120s;
            fastcgi_read_timeout 120s;
            fastcgi_param DOCUMENT_ROOT $realpath_root;
            fastcgi_param SCRIPT_FILENAME $realpath_root/index.php;
            fastcgi_param HTTPS $http_x_forwarded_proto;
        }

        location @imageResizer {
            fastcgi_pass php-upstream;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $realpath_root/imageResizer.php;
        }

        # plain 404 page for missing files accessed via CDN
        # to avoid displaying storefront on the CDN domain
        location @404 {
            internal;
            types {}
            default_type text/html;
            return 404 "File not found";
        }
    }
kind: ConfigMap
metadata:
  name: nginx-default-config
  namespace: myproject-production
---
apiVersion: v1
data:
  www.conf: |
    ; The below default configuration is based on a server without much resources.
    ; Don't forget to tweak it to fit expected workload and hardware.
    ;
    ; https://www.php.net/manual/en/install.fpm.configuration.php
    [global]

    log_level = warning

    [www]

    listen = 127.0.0.1:9000
    ping.path = /ping
    ping.response = pong

    pm = dynamic
    pm.max_children = 20
    pm.start_servers = 5
    pm.min_spare_servers = 5
    pm.max_spare_servers = 10
    pm.max_requests = 400

    request_terminate_timeout = 60s

    access.log = /dev/null
kind: ConfigMap
metadata:
  name: production-php-fpm
  namespace: myproject-production
---
apiVersion: v1
data:
  php-opcache.ini: |
    opcache.enable = 1
    opcache.fast_shutdown = true
    opcache.interned_strings_buffer = 24
    opcache.max_accelerated_files = 60000
    opcache.memory_consumption = 256
    opcache.revalidate_path = 0
    opcache.revalidate_freq = 0
    opcache.validate_timestamps = 0
    opcache.use_cwd = 0
    opcache.preload = "/var/www/html/app/preload.php"
kind: ConfigMap
metadata:
  name: production-php-opcache
  namespace: myproject-production
---
apiVersion: v1
kind: Service
metadata:
  name: storefront
  namespace: myproject-production
spec:
  ports:
  - name: storefront
    port: 3000
    targetPort: 3000
  selector:
    app: storefront
---
apiVersion: v1
kind: Service
metadata:
  name: webserver-php-fpm
  namespace: myproject-production
spec:
  ports:
  - name: http
    port: 8080
    targetPort: 8080
  selector:
    app: webserver-php-fpm
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: cron
  name: cron
  namespace: myproject-production
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cron
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        logging/enabled: "true"
        project/app: cron
        project/environment: production
        project/name: myproject
      labels:
        app: cron
        date: "1234567890"
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - preference:
              matchExpressions:
              - key: workload
                operator: In
                values:
                - background
            weight: 100
      containers:
      - args:
        - |
          ./phing warmup > /dev/null
          # FIFO for logs rm -f /tmp/log-pipe && mkfifo /tmp/log-pipe && chmod 666 /tmp/log-pipe
          # crontab crontab -u root /var/spool/cron/template
          # run on backround stdbuf -o0 tail -n +1 -f /tmp/log-pipe &
          exec crond -f || exec cron -f
        command:
        - /bin/sh
        - -lc
        env:
        - name: ELASTICSEARCH_HOST
          value: http://elasticsearch:9200
        - name: TRUSTED_PROXY
          value: 10.0.0.0/8
        - name: DATABASE_NAME
          value: myproject-production
        - name: S3_ENDPOINT
          value: https://s3.example.com
        - name: MAILER_FORCE_WHITELIST
          value: "false"
        - name: DATABASE_USER
          value: myproject-production
        - name: DATABASE_PORT
          value: "5432"
        - name: MESSENGER_TRANSPORT_DSN
          value: amqp://guest:guest@rabbitmq:5672/%2f/messages
        - name: REDIS_PREFIX
          value: myproject-production
        - name: DATABASE_PASSWORD
          value: test-db-password
        - name: DATABASE_HOST
          value: 10.0.0.100
        - name: ELASTIC_SEARCH_INDEX_PREFIX
          value: myproject-production
        - name: SENTRY_RELEASE
          value: "479411e7"
        - name: S3_SECRET
          value: test-s3-secret
        - name: MAILER_DSN
          value: smtp://mailhog:1025
        - name: S3_BUCKET_NAME
          value: myproject-production
        - name: S3_ACCESS_KEY
          value: myproject-production
        - name: APP_SECRET
          value: test-app-secret-key
        image: v1.0.0
        imagePullPolicy: IfNotPresent
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/sh
              - -lc
              - |
                ( ./bin/console deploy:cron:lock > /tmp/cron-lock.log 2>&1 || true ) &
                ./bin/console deploy:cron:watch || true
        name: cron
        securityContext:
          runAsUser: 0
        volumeMounts:
        - mountPath: /var/www/html/config/domains_urls.yaml
          name: domains-urls
          subPath: domains_urls.yaml
        - mountPath: /var/spool/cron/template
          name: cron-list
          subPath: cron
        - mountPath: /root/.project_env.sh
          name: cron-env
          subPath: .project_env.sh
        - mountPath: /var/www/html/config/frontend-api
          name: fe-api-keys-volume
          readOnly: true
        workingDir: /var/www/html
      imagePullSecrets:
      - name: dockerregistry
      terminationGracePeriodSeconds: 3000
      tolerations:
      - effect: NoSchedule
        key: workload
        operator: Equal
        value: background
      volumes:
      - configMap:
          name: domains-urls-m8t7497btf
        name: domains-urls
      - configMap:
          name: cron-list
        name: cron-list
      - configMap:
          name: cron-env
        name: cron-env
      - name: fe-api-keys-volume
        secret:
          defaultMode: 420
          secretName: fe-api-keys
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: storefront
  namespace: myproject-production
spec:
  replicas: 1
  selector:
    matchLabels:
      app: storefront
  strategy:
    rollingUpdate:
      maxSurge: 50%
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      annotations:
        logging/enabled: "false"
        project/app: storefront
        project/environment: production
        project/name: myproject
      labels:
        app: storefront
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - storefront
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - env:
        - name: SENTRY_RELEASE
          value: "479411e7"
        - name: DOMAIN_HOSTNAME_1
          value: https://www.example.com/
        - name: PUBLIC_GRAPHQL_ENDPOINT_HOSTNAME_1
          value: https://www.example.com/graphql/
        - name: DOMAIN_HOSTNAME_2
          value: https://www.example.sk/
        - name: PUBLIC_GRAPHQL_ENDPOINT_HOSTNAME_2
          value: https://www.example.sk/graphql/
        - name: INTERNAL_ENDPOINT
          value: http://webserver-php-fpm:8080/
        image: v1.0.0
        lifecycle:
          preStop:
            exec:
              command:
              - sleep
              - "10"
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 5
        name: storefront
        ports:
        - containerPort: 3000
          name: storefront
          protocol: TCP
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 5
        resources:
          limits:
            memory: 1.5Gi
          requests:
            cpu: 500m
            memory: 800Mi
      imagePullSecrets:
      - name: dockerregistry
      terminationGracePeriodSeconds: 60
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: webserver-php-fpm
  name: webserver-php-fpm
  namespace: myproject-production
spec:
  progressDeadlineSeconds: 1500
  replicas: 1
  selector:
    matchLabels:
      app: webserver-php-fpm
  strategy:
    rollingUpdate:
      maxSurge: 50%
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      annotations:
        logging/enabled: "true"
        project/app: app
        project/environment: production
        project/name: myproject
      labels:
        app: webserver-php-fpm
    spec:
      affinity:
        podAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - redis
              topologyKey: kubernetes.io/hostname
            weight: 100
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - webserver-php-fpm
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - env:
        - name: ELASTICSEARCH_HOST
          value: http://elasticsearch:9200
        - name: TRUSTED_PROXY
          value: 10.0.0.0/8
        - name: DATABASE_NAME
          value: myproject-production
        - name: S3_ENDPOINT
          value: https://s3.example.com
        - name: MAILER_FORCE_WHITELIST
          value: "false"
        - name: DATABASE_USER
          value: myproject-production
        - name: DATABASE_PORT
          value: "5432"
        - name: MESSENGER_TRANSPORT_DSN
          value: amqp://guest:guest@rabbitmq:5672/%2f/messages
        - name: REDIS_PREFIX
          value: myproject-production
        - name: DATABASE_PASSWORD
          value: test-db-password
        - name: DATABASE_HOST
          value: 10.0.0.100
        - name: ELASTIC_SEARCH_INDEX_PREFIX
          value: myproject-production
        - name: SENTRY_RELEASE
          value: "479411e7"
        - name: S3_SECRET
          value: test-s3-secret
        - name: MAILER_DSN
          value: smtp://mailhog:1025
        - name: S3_BUCKET_NAME
          value: myproject-production
        - name: S3_ACCESS_KEY
          value: myproject-production
        - name: APP_SECRET
          value: test-app-secret-key
        image: v1.0.0
        imagePullPolicy: IfNotPresent
        lifecycle:
          postStart:
            exec:
              command:
              - /var/www/html/phing
              - -S
              - warmup
          preStop:
            exec:
              command:
              - /bin/sh
              - -lc
              - sleep 10; kill -QUIT 1 || true
        livenessProbe:
          initialDelaySeconds: 30
          periodSeconds: 10
          tcpSocket:
            port: 9000
          timeoutSeconds: 2
        name: php-fpm
        readinessProbe:
          initialDelaySeconds: 2
          periodSeconds: 5
          tcpSocket:
            port: 9000
          timeoutSeconds: 2
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: 500m
            memory: 500Mi
        volumeMounts:
        - mountPath: /var/www/html
          name: source-codes
        - mountPath: /var/www/html/config/domains_urls.yaml
          name: domains-urls
          subPath: domains_urls.yaml
        - mountPath: /usr/local/etc/php-fpm.d/www.conf
          name: production-php-fpm
          subPath: www.conf
        - mountPath: /usr/local/etc/php/conf.d/php-opcache.ini
          name: production-php-opcache
          subPath: php-opcache.ini
        - mountPath: /var/www/html/config/frontend-api
          name: fe-api-keys-volume
          readOnly: true
        workingDir: /var/www/html
      - image: nginx:1.27-alpine
        lifecycle:
          preStop:
            exec:
              command:
              - sh
              - -c
              - sleep 5 && /usr/sbin/nginx -s quit
        livenessProbe:
          failureThreshold: 6
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 3
        name: webserver
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 80
          name: health
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 2
          periodSeconds: 5
          timeoutSeconds: 2
        resources:
          limits:
            memory: 300Mi
          requests:
            cpu: 50m
            memory: 100Mi
        volumeMounts:
        - mountPath: /etc/nginx/nginx.conf
          name: nginx-default-config
          subPath: nginx.conf
        - mountPath: /etc/nginx/conf.d/default.conf
          name: nginx-default-config
          subPath: project-nginx.conf
        - mountPath: /var/www/html
          name: source-codes
      hostAliases:
      - hostnames:
        - webserver-php-fpm
        - php-fpm
        - webserver
        ip: 127.0.0.1
      imagePullSecrets:
      - name: dockerregistry
      initContainers:
      - command:
        - sh
        - -c
        - cp -r -n /var/www/html/. /tmp/source-codes
        image: v1.0.0
        name: copy-source-codes-to-volume
        volumeMounts:
        - mountPath: /tmp/source-codes
          name: source-codes
        - mountPath: /var/www/html/config/domains_urls.yaml
          name: domains-urls
          subPath: domains_urls.yaml
      terminationGracePeriodSeconds: 120
      volumes:
      - emptyDir: {}
        name: source-codes
      - configMap:
          name: domains-urls-m8t7497btf
        name: domains-urls
      - configMap:
          name: nginx-default-config
        name: nginx-default-config
      - configMap:
          name: production-php-fpm
        name: production-php-fpm
      - configMap:
          name: production-php-opcache
        name: production-php-opcache
      - name: fe-api-keys-volume
        secret:
          defaultMode: 420
          secretName: fe-api-keys
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: storefront
  namespace: myproject-production
spec:
  maxReplicas: 3
  metrics:
  - resource:
      name: cpu
      target:
        averageUtilization: 120
        type: Utilization
    type: Resource
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: storefront
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: webserver-php-fpm
  namespace: myproject-production
spec:
  maxReplicas: 3
  metrics:
  - containerResource:
      container: php-fpm
      name: cpu
      target:
        averageUtilization: 120
        type: Utilization
    type: ContainerResource
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: webserver-php-fpm
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/configuration-snippet: if ($scheme = http) { return
      308 https://$host$request_uri; } if ($host ~ ^(?!www\.)(?<domain>.+)$) { return
      308 https://www.$domain$request_uri; }
    nginx.ingress.kubernetes.io/proxy-body-size: 32m
  name: eshop-domain-0
  namespace: myproject-production
spec:
  ingressClassName: nginx
  rules:
  - host: www.example.com
    http:
      paths:
      - backend:
          service:
            name: webserver-php-fpm
            port:
              number: 8080
        path: /
        pathType: Prefix
  - host: example.com
  tls:
  - hosts:
    - www.example.com
    - example.com
    secretName: tls-www-example-com
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/configuration-snippet: if ($scheme = http) { return
      308 https://$host$request_uri; } if ($host ~ ^(?!www\.)(?<domain>.+)$) { return
      308 https://www.$domain$request_uri; }
    nginx.ingress.kubernetes.io/proxy-body-size: 32m
  name: eshop-domain-1
  namespace: myproject-production
spec:
  ingressClassName: nginx
  rules:
  - host: www.example.sk
    http:
      paths:
      - backend:
          service:
            name: webserver-php-fpm
            port:
              number: 8080
        path: /
        pathType: Prefix
  - host: example.sk
  tls:
  - hosts:
    - www.example.sk
    - example.sk
    secretName: tls-www-example-sk
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: 32m
    nginx.ingress.kubernetes.io/whitelist-source-range: 10.0.0.0/8
  name: rabbitmq-domain
  namespace: myproject-production
spec:
  ingressClassName: nginx
  rules:
  - host: rabbitmq.www.example.com
    http:
      paths:
      - backend:
          service:
            name: rabbitmq
            port:
              number: 15672
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - rabbitmq.www.example.com
    secretName: tls-certificate
