apiVersion: v1
kind: Namespace
metadata:
  name: myproject-dev
---
apiVersion: v1
data:
  .project_env.sh: |
    export ELASTICSEARCH_HOST='http://elasticsearch:9200'
    export TRUSTED_PROXY='10.0.0.0/8'
    export DATABASE_NAME='myproject-dev'
    export S3_ENDPOINT='https://s3.example.com'
    export MAILER_FORCE_WHITELIST='true'
    export DATABASE_USER='myproject-dev'
    export DATABASE_PORT='5432'
    export MESSENGER_TRANSPORT_DSN='amqp://guest:guest@rabbitmq:5672/%2f/messages'
    export REDIS_PREFIX='myproject-dev'
    export DATABASE_PASSWORD='test-db-password'
    export DATABASE_HOST='10.0.0.100'
    export ELASTIC_SEARCH_INDEX_PREFIX='myproject-dev'
    export S3_SECRET='test-s3-secret'
    export MAILER_DSN='smtp://mailhog:1025'
    export S3_BUCKET_NAME='myproject-dev'
    export S3_ACCESS_KEY='myproject-dev'
    export APP_SECRET='test-app-secret-key'
kind: ConfigMap
metadata:
  name: cron-env
  namespace: myproject-dev
---
apiVersion: v1
data:
  cron: |+
    PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    */5 * * * * . /root/.project_env.sh && cd /var/www/html/ && ./phing cron > /dev/null 2>&1

kind: ConfigMap
metadata:
  name: cron-list
  namespace: myproject-dev
---
apiVersion: v1
data:
  domains_urls.yaml: |
    domains_urls:
      - id: 1
        url: https://dev.example.com
kind: ConfigMap
metadata:
  name: domains-urls-5f46tgkghd
  namespace: myproject-dev
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: cron
  name: cron
  namespace: myproject-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cron
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        logging/enabled: "true"
        project/app: cron
        project/environment: dev
        project/name: myproject
      labels:
        app: cron
        date: "1234567890"
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - preference:
              matchExpressions:
              - key: workload
                operator: In
                values:
                - background
            weight: 100
      containers:
      - args:
        - |
          ./phing warmup > /dev/null
          # FIFO for logs rm -f /tmp/log-pipe && mkfifo /tmp/log-pipe && chmod 666 /tmp/log-pipe
          # crontab crontab -u root /var/spool/cron/template
          # run on backround stdbuf -o0 tail -n +1 -f /tmp/log-pipe &
          exec crond -f || exec cron -f
        command:
        - /bin/sh
        - -lc
        env:
        - name: ELASTICSEARCH_HOST
          value: http://elasticsearch:9200
        - name: TRUSTED_PROXY
          value: 10.0.0.0/8
        - name: DATABASE_NAME
          value: myproject-dev
        - name: S3_ENDPOINT
          value: https://s3.example.com
        - name: MAILER_FORCE_WHITELIST
          value: "true"
        - name: DATABASE_USER
          value: myproject-dev
        - name: DATABASE_PORT
          value: "5432"
        - name: MESSENGER_TRANSPORT_DSN
          value: amqp://guest:guest@rabbitmq:5672/%2f/messages
        - name: REDIS_PREFIX
          value: myproject-dev
        - name: DATABASE_PASSWORD
          value: test-db-password
        - name: DATABASE_HOST
          value: 10.0.0.100
        - name: ELASTIC_SEARCH_INDEX_PREFIX
          value: myproject-dev
        - name: S3_SECRET
          value: test-s3-secret
        - name: MAILER_DSN
          value: smtp://mailhog:1025
        - name: S3_BUCKET_NAME
          value: myproject-dev
        - name: S3_ACCESS_KEY
          value: myproject-dev
        - name: APP_SECRET
          value: test-app-secret-key
        image: dev-latest
        imagePullPolicy: IfNotPresent
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/sh
              - -lc
              - |
                ( ./bin/console deploy:cron:lock > /tmp/cron-lock.log 2>&1 || true ) &
                ./bin/console deploy:cron:watch || true
        name: cron
        securityContext:
          runAsUser: 0
        volumeMounts:
        - mountPath: /var/www/html/config/domains_urls.yaml
          name: domains-urls
          subPath: domains_urls.yaml
        - mountPath: /var/spool/cron/template
          name: cron-list
          subPath: cron
        - mountPath: /root/.project_env.sh
          name: cron-env
          subPath: .project_env.sh
        - mountPath: /var/www/html/config/frontend-api
          name: fe-api-keys-volume
          readOnly: true
        workingDir: /var/www/html
      imagePullSecrets:
      - name: dockerregistry
      terminationGracePeriodSeconds: 3000
      tolerations:
      - effect: NoSchedule
        key: workload
        operator: Equal
        value: background
      volumes:
      - configMap:
          name: domains-urls-5f46tgkghd
        name: domains-urls
      - configMap:
          name: cron-list
        name: cron-list
      - configMap:
          name: cron-env
        name: cron-env
      - name: fe-api-keys-volume
        secret:
          defaultMode: 420
          secretName: fe-api-keys
